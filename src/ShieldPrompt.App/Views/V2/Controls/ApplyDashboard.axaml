<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:ShieldPrompt.App.ViewModels.V2"
             x:DataType="vm:ApplyDashboardViewModel"
             x:Class="ShieldPrompt.App.Views.V2.Controls.ApplyDashboard">

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Header -->
        <Border Grid.Row="0" Background="#181825" Padding="12" BorderBrush="#313244" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="ðŸ“¥ APPLY DASHBOARD"
                               FontWeight="Bold"
                               Foreground="#89b4fa"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding ParseStatusText}"
                               Foreground="#6c7086"
                               VerticalAlignment="Center"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Content="Clear" Command="{Binding ClearCommand}" Padding="8,4"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1" RowDefinitions="Auto,*">

            <!-- Response Input Area -->
            <Border Grid.Row="0"
                    Background="#11111b"
                    Padding="12"
                    IsVisible="{Binding !HasParsedOperations}">
                <Grid RowDefinitions="Auto,*,Auto">
                    <TextBlock Grid.Row="0"
                               Text="Paste LLM Response:"
                               Foreground="#a6adc8"
                               Margin="0,0,0,8"/>
                    <TextBox Grid.Row="1"
                             Text="{Binding ResponseText}"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             MinHeight="200"
                             MaxHeight="400"
                             Watermark="Paste the AI response here..."
                             Background="#1e1e2e"
                             BorderBrush="#45475a"/>
                    <Button Grid.Row="2"
                            Content="ðŸ” Parse Response"
                            Command="{Binding ParseResponseCommand}"
                            IsEnabled="{Binding !IsParsing}"
                            HorizontalAlignment="Right"
                            Margin="0,12,0,0"
                            Padding="16,8"
                            Background="#89b4fa"
                            Foreground="#1e1e2e"/>
                </Grid>
            </Border>

            <!-- Operations List -->
            <Grid Grid.Row="1"
                  RowDefinitions="Auto,*"
                  IsVisible="{Binding HasParsedOperations}">

                <!-- Summary Bar -->
                <Border Grid.Row="0" Background="#1e1e2e" Padding="12">
                    <Grid ColumnDefinitions="*,Auto">
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16">
                            <!-- Counts -->
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="âž•" Foreground="LightGreen"/>
                                <TextBlock Text="{Binding CreateCount}" Foreground="LightGreen"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="âœï¸" Foreground="Orange"/>
                                <TextBlock Text="{Binding UpdateCount}" Foreground="Orange"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="ðŸ—‘ï¸" Foreground="Red"/>
                                <TextBlock Text="{Binding DeleteCount}" Foreground="Red"/>
                            </StackPanel>
                            <TextBlock Text="|" Foreground="#45475a"/>
                            <TextBlock Foreground="#6c7086">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}{0}/{1} selected">
                                        <Binding Path="SelectedCount"/>
                                        <Binding Path="TotalCount"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                        </StackPanel>
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                            <Button Content="Select All"
                                    Command="{Binding SelectAllCommand}"
                                    Padding="8,4"/>
                            <Button Content="Deselect All"
                                    Command="{Binding DeselectAllCommand}"
                                    Padding="8,4"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Operations List -->
                <ScrollViewer Grid.Row="1" Background="#11111b">
                    <ItemsControl ItemsSource="{Binding Operations}" Margin="8">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:FileOperationViewModel">
                                <Border Background="#1e1e2e"
                                        CornerRadius="6"
                                        Margin="0,4"
                                        Padding="12">
                                    <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto">
                                        <!-- Checkbox -->
                                        <CheckBox Grid.Column="0"
                                                  IsChecked="{Binding IsSelected}"
                                                  VerticalAlignment="Center"
                                                  Margin="0,0,12,0"/>

                                        <!-- Type Badge -->
                                        <Border Grid.Column="1"
                                                Background="{Binding TypeColor}"
                                                CornerRadius="4"
                                                Padding="8,4"
                                                Margin="0,0,12,0"
                                                VerticalAlignment="Center">
                                            <TextBlock Text="{Binding TypeName}"
                                                       FontSize="10"
                                                       FontWeight="Bold"
                                                       Foreground="#1e1e2e"/>
                                        </Border>

                                        <!-- File Info -->
                                        <StackPanel Grid.Column="2" VerticalAlignment="Center">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <TextBlock Text="{Binding FileName}"
                                                           FontWeight="SemiBold"
                                                           Foreground="#cdd6f4"/>
                                                <TextBlock Text="{Binding StatusIcon}"/>
                                            </StackPanel>
                                            <TextBlock Text="{Binding Directory}"
                                                       FontSize="11"
                                                       Foreground="#6c7086"/>
                                            <TextBlock Text="{Binding Reason}"
                                                       FontSize="11"
                                                       Foreground="#a6adc8"
                                                       TextWrapping="Wrap"
                                                       Margin="0,4,0,0"/>
                                            <TextBlock Text="{Binding ErrorMessage}"
                                                       FontSize="11"
                                                       Foreground="#f38ba8"
                                                       IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                                       Margin="0,4,0,0"/>
                                        </StackPanel>

                                        <!-- Destructive Warning -->
                                        <TextBlock Grid.Column="3"
                                                   Text="âš ï¸"
                                                   ToolTip.Tip="Destructive operation"
                                                   IsVisible="{Binding IsDestructive}"
                                                   VerticalAlignment="Center"
                                                   Margin="8,0"/>

                                        <!-- Expand Button -->
                                        <ToggleButton Grid.Column="4"
                                                      IsChecked="{Binding IsExpanded}"
                                                      Background="Transparent"
                                                      Padding="8,4"
                                                      VerticalAlignment="Center">
                                            <Panel>
                                                <TextBlock Text="â–¶" IsVisible="{Binding !IsExpanded}"/>
                                                <TextBlock Text="â–¼" IsVisible="{Binding IsExpanded}"/>
                                            </Panel>
                                        </ToggleButton>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- Action Bar -->
        <Border Grid.Row="2"
                Background="#181825"
                Padding="12"
                BorderBrush="#313244"
                BorderThickness="0,1,0,0"
                IsVisible="{Binding HasParsedOperations}">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                    <Button Content="â†©ï¸ Undo Last"
                            Command="{Binding UndoCommand}"
                            IsEnabled="{Binding CanUndo}"
                            Padding="12,8"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Content="Apply Selected"
                            Command="{Binding ApplySelectedCommand}"
                            IsEnabled="{Binding !IsApplying}"
                            Padding="16,8"
                            Background="#89b4fa"
                            Foreground="#1e1e2e"/>
                    <Button Content="Apply All"
                            Command="{Binding ApplyAllCommand}"
                            IsEnabled="{Binding !IsApplying}"
                            Padding="16,8"
                            Background="#a6e3a1"
                            Foreground="#1e1e2e"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
